import os

import aiohttp
import pytest
from azure.core.exceptions import ResourceNotFoundError
from azure.core.pipeline.transport import (
    AioHttpTransportResponse,
    AsyncHttpTransport,
    HttpRequest,
)
from azure.storage.blob.aio import BlobServiceClient

from approaches.approach import Document
from core.imageshelper import fetch_image

from .mocks import MockAzureCredential


@pytest.mark.asyncio
async def test_content_file(monkeypatch, mock_env, mock_acs_search):
    class MockAiohttpClientResponse404(aiohttp.ClientResponse):
        def __init__(self, url, body_bytes, headers=None):
            self._body = body_bytes
            self._headers = headers
            self._cache = {}
            self.status = 404
            self.reason = "Not Found"
            self._url = url

    class MockAiohttpClientResponse(aiohttp.ClientResponse):
        def __init__(self, url, body_bytes, headers=None):
            self._body = body_bytes
            self._headers = headers
            self._cache = {}
            self.status = 200
            self.reason = "OK"
            self._url = url

    class MockTransport(AsyncHttpTransport):
        async def send(self, request: HttpRequest, **kwargs) -> AioHttpTransportResponse:
            if request.url.endswith("notfound.png"):
                raise ResourceNotFoundError(MockAiohttpClientResponse404(request.url, b""))
            else:
                return AioHttpTransportResponse(
                    request,
                    MockAiohttpClientResponse(
                        request.url,
                        b"test content",
                        {
                            "Content-Type": "application/octet-stream",
                            "Content-Range": "bytes 0-27/28",
                            "Content-Length": "28",
                        },
                    ),
                )

        async def __aenter__(self):
            return self

        async def __aexit__(self, *args):
            pass

        async def open(self):
            pass

        async def close(self):
            pass

    # Then we can plug this into any SDK via kwargs:
    blob_client = BlobServiceClient(
        f"https://{os.environ['AZURE_STORAGE_ACCOUNT']}.blob.core.windows.net",
        credential=MockAzureCredential(),
        transport=MockTransport(),
        retry_total=0,  # Necessary to avoid unnecessary network requests during tests
    )
    blob_container_client = blob_client.get_container_client(os.environ["AZURE_STORAGE_CONTAINER"])

    test_document = Document(
        id="test",
        content="test content",
        embedding=[1, 2, 3],
        image_embedding=[4, 5, 6],
        oids=[],
        groups=[],
        captions=[],
        category="",
        sourcefile="test.pdf",
        sourcepage="test.pdf#page2",
    )
    image_url = await fetch_image(blob_container_client, test_document)
    assert image_url is not None
    assert image_url["url"] == "data:image/png;base64,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QI6QAQAAcoQMAACQI2QAAIAcIQMAAOQIGQAAIEfIAAAAOUIGAADIETIAAECOkAEAAHKEDAAAkCNkAACAHCEDAADkCBkAACBHyAAAADlCBgAAyBEyAABAjpABAAByhAwAAJAjZAAAgBwhAwAA5AgZAAAgR8gAAAA5QgYAAMgRMgAAQI6QAQAAcoQMAACQI2QAAIAcIQMAAOQIGQAAIEfIAAAAOUIGAADIETIAAECOkAEAAHKEDAAAkCNkAACAHCEDAADkCBkAACBHyAAAADlCBgAAyBEyAABAjpABAAByhAwAAJAjZAAAgBwhAwAA5AgZAAAgR8gAAAA5QgYAAMgRMgAAQI6QAQAAcoQMAACQI2QAAIAcIQMAAOQIGQAAIEfIAAAAOUIGAADIETIAAECOkAEAAHKEDAAAkCNkAACAHCEDAADkCBkAACBHyAAAADlCBgAAyBEyAABAjpABAAByhAwAAJAjZAAAgBwhAwAA5AgZAAAgR8gAAAA5QgYAAMgRMgAAQI6QAQAAcoQMAACQI2QAAIAcIQMAAOQIGQAAIEfIAAAAOUIGAADIETIAAECOkAEAAHKEDAAAkCNkAACAHCEDAADkCBkAACBHyAAAADlCBgAAyBEyAABAjpABAAByhAwAAJAjZAAAgBwhAwAA5AgZAAAgR8gAAAA5QgYAAMgRMgAAQI6QAQAAcoQMAACQI2QAAIAcIQMAAOQIGQAAIEfIAAAAOUIGAADIETIAAECOkAEAAHKEDAAAkCNkAACAHCEDAADkCBkAACBHyAAAADlCBgAAyBEyAABAjpABAAByhAwAAJAjZAAAgBwhAwAA5AgZAAAgR8gAAAA5QgYAAMgRMgAAQI6QAQAAcoQMAACQI2QAAIAcIQMAAOQIGQAAIEfIAAAAOUIGAADIETIAAECOkAEAAHKEDAAAkCNkAACAHCEDAADkCBkAACBHyAAAADlCBgAAyBEyAABAjpABAAByhAwAAJAjZAAAgBwhAwAA5AgZAAAgR8gAAAA5QgYAAMgRMgAAQI6QAQAAcoQMAACQI2QAAIAcIQMAAOQIGQAAIEfIAAAAOUIGAADIETIAAECOkAEAAHKEDAAAkCNkAACAHCEDAADkCBkAACBHyAAAADlCBgAAyBEyAABAjpABAAByhAwAAJAjZAAAgBwhAwAA5AgZAAAgR8gAAAA5QgYAAMgR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"
    assert image_url["detail"] == "auto"

    test_document.sourcepage = "notfound.pdf"
    image_url = await fetch_image(blob_container_client, test_document)
    assert image_url is None

    test_document.sourcepage = ""
    image_url = await fetch_image(blob_container_client, test_document)
    assert image_url is None
